# 店舗管理機能 (Shop Management) 仕様書

## 1. 概要
店舗オーナーおよび管理者（代理操作）が、店舗の基本情報、営業時間、メニュー、スタンプカード設定などを管理するための機能群。

## 2. データ構造

### 2.1. 営業時間 (`opening_hours`)
`shops` テーブルの `opening_hours` カラム（JSONB）に、以下のJSON構造でデータを保存する。

**JSON構造:**
```json
{
  "mon": { "open": "09:00", "close": "18:00", "is_closed": false },
  "tue": { "open": "09:00", "close": "18:00", "is_closed": false },
  "wed": { "open": "09:00", "close": "18:00", "is_closed": false },
  "thu": { "open": "09:00", "close": "18:00", "is_closed": false },
  "fri": { "open": "09:00", "close": "18:00", "is_closed": false },
  "sat": { "open": "10:00", "close": "20:00", "is_closed": false },
  "sun": { "open": "10:00", "close": "20:00", "is_closed": true }
}
```

- キーは曜日（`mon`, `tue`, `wed`, `thu`, `fri`, `sat`, `sun`）。
- `open`: 開店時間 (HH:MM形式)。
- `close`: 閉店時間 (HH:MM形式)。
- `is_closed`: 定休日フラグ (trueの場合、営業時間は無視される)。

### 2.2. 店舗ジャンル
検索機能の拡充のため、以下のカラムを使用する。

- **`category_main`** (TEXT): 大分類
  - 選択肢: カフェ, 居酒屋, 和食, イタリアン, 焼肉, スイーツ, バー, スナック, ラーメン, 洋食, 日本料理, 弁当, 軽食, 牛丼, 中華, パン, 寿司, お好み焼き, ファストフード, カレー, ハンバーガー, うどん, そば, フレンチ, 韓国料理, エスニック
- **`category_sub`** (TEXT): 中分類・詳細
  - 自由記述（例: オムライス専門店, 滋賀の野菜たっぷり）
- **`meal_type`** (TEXT): 食事タイプ
  - 選択肢: モーニング, ランチ, ディナー, カフェ, テイクアウト, バータイム, 24時間

### 2.3. 予算帯 (`price_range`)
ユーザーが店を選ぶ際の予算目安。

- **`price_range`** (TEXT): 予算目安
  - 選択肢:
    - ~1,000円
    - 1,000円~2,000円
    - 2,000円~3,000円
    - 3,000円~5,000円
    - 5,000円~10,000円
    - 10,000円~

### 2.4. 電話番号
用途に応じて2つのカラムを使い分ける。

- **`phone`** (TEXT): **一般公開用（店舗問い合わせ用）**
  - アプリ上で一般ユーザーに公開される。
  - 「電話をかける」ボタンのリンク先となる。
- **`phone_number`** (TEXT): **オーナー連絡用（管理者用）**
  - 管理画面でのみ確認可能。
  - 運営からの緊急連絡先などとして使用。

## 3. 機能要件

### 3.1. 営業時間設定
- **画面**: `app/shop/settings/page.tsx`
- **操作**:
  - 曜日ごとに「開店時間」「閉店時間」「定休日」を設定可能。
  - 「保存」ボタンで一括保存。
- **保存ロジック**:
  - Server Action (`updateShopOpeningHours`) を呼び出す。
  - カラム型は `jsonb` であるが、クライアント/サーバー間ではオブジェクトとして受け渡し、必要に応じてパース処理を行う堅牢な実装とする。

### 3.2. 基本情報・ジャンル設定
- **画面**: `app/shop/settings/page.tsx`
- **操作**:
  - 店舗名、住所（管理者のみ編集可）、電話番号に加え、ジャンル設定が可能。
  - **電話番号入力**: 公開用 (`phone`) とオーナー連絡用 (`phone_number`) の2つのフィールドを提供する。
  - `updateShopBasicInfo` アクションで一括保存。
- **検索連動**:
  - ユーザー側の「たべる」ページ (`app/taberu/page.tsx`) で、`category_main`、`category_sub`、`meal_type` の内容が検索対象となる。

## 4. 権限管理
- **店舗オーナー**: 自分の店舗のみ編集可能 (`owner_id` チェック)。
- **管理者**: `impersonateShopId` を指定することで、任意の店舗を代理編集可能。
