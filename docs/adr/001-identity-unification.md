# ADR 001: ID紐付けの統一 (Identity Unification)

## ステータス
Accepted

## 背景
本プロジェクトには「店舗 (`shops`)」と「ユーザー (`profiles` / `auth.users`)」という2つの主要なエンティティが存在する。
機能実装を進める中で、銀行口座情報 (`shop_bank_details`) や振込申請 (`payout_requests`) をどちらの ID に紐付けるべきかという設計判断が必要となった。

現状の運用想定では「1ユーザー = 1店舗オーナー」であるが、将来的な拡張（複数店舗管理など）も考慮する必要がある。しかし、法的な振込先や本人確認 (KYC) の単位は「店舗（場所）」ではなく「個人（または法人）」である。

## 決定事項
**金銭に関わる情報（銀行口座、振込申請）は、店舗ID (`shops.id`) ではなく、個人ID (`profiles.id` / Owner ID) に紐付ける。**

具体的には以下の通り実装する：
1.  `shop_bank_details` テーブルの `shop_id` カラムには `owner_id` を格納する。
2.  `payout_requests` テーブルの `shop_id` カラムには `owner_id` を格納する。
3.  `menu_items` などの店舗固有コンテンツは、引き続き `shops.id` に紐付ける。

## 理由
1.  **実体との整合性**: 銀行口座は法的人格（個人事業主または法人）に紐づくものであり、物理的な店舗拠点（ショップ）とは異なる。
2.  **セキュリティとアクセス制御**: Supabase RLS において `auth.uid() = shop_id` (実質 user_id) というシンプルなポリシーで本人限定アクセスを実現できる。
3.  **データの一元管理**: ユーザーが将来複数の店舗を持った場合でも、売上の振込先は1つのメイン口座に集約されるケースが一般的であり、店舗ごとに口座設定を強いるのを避けるため。

## 影響
*   **命名の不一致**: テーブルカラム名が `shop_id` のままであるが、中身が User ID となるため、コード上で `userId` や `ownerId` を渡す箇所で混乱が生じないよう注意が必要（コメント等で明記する）。
*   **FK制約**: `shop_bank_details.shop_id` は `shops(id)` ではなく `auth.users(id)` (または `profiles(id)`) を参照する必要がある。

## 関連ドキュメント
*   docs/specs/payout.md
*   docs/specs/bank-settings.md
