# ADR 005: School Rankings Update Strategy and Privacy

## Context
学生コミュニティ機能において、学校ごとの走行距離ランキングを表示する必要があります。
このランキングは、`activity_logs` (数千〜数万件想定) の集計を伴うため、パフォーマンスへの影響を考慮する必要があります。
また、学生の実名が表示されることによるプライバシーリスクを回避する必要があります。

## Decision

### 1. ランキングの更新頻度 (Update Frequency)
**Decision: リアルタイム集計 (Real-time Aggregation) with Caching Strategy**

- **理由**:
  - 現在のユーザー規模（初期段階）では、数千件程度の `activity_logs` であれば PostgreSQL のインデックスを活用した `SUM` 集計は高速に動作するため。
  - ユーザーが活動記録を送信した直後にランキングに反映される体験（Gamification）を重視するため。

- **将来的な対策 (Future Considerations)**:
  - ユーザー数が増加し、クエリ負荷が高まった場合は、以下のいずれかの対策を講じる。
    1.  **Materialized View**: 1時間ごとに更新するマテリアライズドビューを作成し、読み取り専用クエリを高速化する。
    2.  **Redis Cache**: 集計結果をRedis等にキャッシュし、TTL (Time To Live) を設定する（例: 5分）。

### 2. プライバシー配慮 (Privacy Considerations)
**Decision: ニックネーム表示の必須化 (Mandatory Nickname Display)**

- **理由**:
  - 学校内ランキングとはいえ、個人特定のリスクがあるため、本名（`full_name`）の直接表示は避けるべきである。
  - プロフィール設定画面において、ランキング表示用の「ニックネーム（`nickname`）」フィールドを追加し、未設定の場合は「匿名ユーザー」またはイニシャル表示とする。
  - 学年（`grade`）は表示するが、その他の個人情報（顔写真など）はユーザーが公開設定を選択した場合のみ表示する（デフォルトは非表示またはアバター）。

## Consequences
- **Positive**:
  - ユーザーは自分の活動が即座にランキングに反映されるため、モチベーション向上が期待できる。
  - プライバシーリスクを最小限に抑えつつ、競争要素を取り入れることができる。

- **Negative**:
  - `activity_logs` テーブルが肥大化すると、集計クエリのパフォーマンス劣化が発生する可能性がある（インデックス設計が重要）。
  - ニックネーム管理のUI/UX追加実装が必要となる。
